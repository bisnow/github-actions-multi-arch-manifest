name: 'Create Multi-Architecture Manifest'
description: 'Creates and pushes multi-platform Docker manifests for amd64 and arm64 to either ECR or Harbor'
inputs:
  image-tag:
    description: 'Image tag to create manifest for'
    required: true
  ecr-registry:
    description: 'ECR registry URL. Provide this OR harbor-registry, not both.'
    required: false
    default: ''
  harbor-registry:
    description: 'Harbor registry URL (e.g., harbor.bisnow.cloud/bisnow/hello-k8s). Provide this OR ecr-registry, not both.'
    required: false
    default: ''
  aws-account:
    description: 'AWS account name for assuming role (only used when pushing to ECR)'
    required: false
    default: 'bisnow'
  git-sha:
    description: 'Git SHA to create manifest for (defaults to github.sha)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Validate registry inputs
      shell: bash
      run: |
        if [ -z "${{ inputs.ecr-registry }}" ] && [ -z "${{ inputs.harbor-registry }}" ]; then
          echo "ERROR: You must provide either ecr-registry or harbor-registry"
          exit 1
        fi
        if [ -n "${{ inputs.ecr-registry }}" ] && [ -n "${{ inputs.harbor-registry }}" ]; then
          echo "ERROR: Provide ecr-registry OR harbor-registry, not both"
          exit 1
        fi

    - name: Set active registry
      id: registry
      shell: bash
      run: |
        if [ -n "${{ inputs.harbor-registry }}" ]; then
          echo "url=${{ inputs.harbor-registry }}" >> $GITHUB_OUTPUT
        else
          echo "url=${{ inputs.ecr-registry }}" >> $GITHUB_OUTPUT
        fi

    - name: Checkout Repository
      uses: actions/checkout@v5

    - name: Assume role for AWS Account
      if: ${{ inputs.harbor-registry == '' }}
      uses: bisnow/github-actions-assume-role-for-environment@main
      with:
        aws-account: ${{ inputs.aws-account }}

    - name: Login to Amazon ECR
      if: ${{ inputs.harbor-registry == '' }}
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Verify Architecture Images Exist
      shell: bash
      run: |
        registry="${{ steps.registry.outputs.url }}"
        image_tag="${{ inputs.image-tag }}"
        git_sha="${{ inputs.git-sha }}"

        if [ -z "$git_sha" ]; then
          git_sha="${{ github.sha }}"
        fi

        echo "ðŸ” Verifying all architecture images are available..."
        max_attempts=30
        attempt=0
        sleep_time=5

        while [ $attempt -lt $max_attempts ]; do
          tag_amd64_exists=false
          tag_arm64_exists=false
          sha_amd64_exists=false
          sha_arm64_exists=false

          echo "Checking image-tag AMD64 image..."
          if docker buildx imagetools inspect "$registry:$image_tag-amd64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$image_tag-amd64"
            tag_amd64_exists=true
          else
            echo "â³ Waiting for: $registry:$image_tag-amd64"
          fi

          echo "Checking image-tag ARM64 image..."
          if docker buildx imagetools inspect "$registry:$image_tag-arm64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$image_tag-arm64"
            tag_arm64_exists=true
          else
            echo "â³ Waiting for: $registry:$image_tag-arm64"
          fi

          echo "Checking git-sha AMD64 image..."
          if docker buildx imagetools inspect "$registry:$git_sha-amd64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$git_sha-amd64"
            sha_amd64_exists=true
          else
            echo "â³ Waiting for: $registry:$git_sha-amd64"
          fi

          echo "Checking git-sha ARM64 image..."
          if docker buildx imagetools inspect "$registry:$git_sha-arm64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$git_sha-arm64"
            sha_arm64_exists=true
          else
            echo "â³ Waiting for: $registry:$git_sha-arm64"
          fi

          if [ "$tag_amd64_exists" = true ] && [ "$tag_arm64_exists" = true ] && [ "$sha_amd64_exists" = true ] && [ "$sha_arm64_exists" = true ]; then
            echo "âœ… All architecture images are available!"
            exit 0
          fi

          attempt=$((attempt + 1))
          if [ $attempt -lt $max_attempts ]; then
            echo "â³ Attempt $attempt/$max_attempts - waiting ${sleep_time}s before retry..."
            sleep $sleep_time
          fi
        done

        echo "âŒ Timeout waiting for architecture images to be available"
        echo "Image-tag AMD64 available: $tag_amd64_exists"
        echo "Image-tag ARM64 available: $tag_arm64_exists"
        echo "Git-SHA AMD64 available: $sha_amd64_exists"
        echo "Git-SHA ARM64 available: $sha_arm64_exists"
        exit 1

    - name: Create Multi-Platform Manifests
      shell: bash
      run: |
        registry="${{ steps.registry.outputs.url }}"
        image_tag="${{ inputs.image-tag }}"
        git_sha="${{ inputs.git-sha }}"

        if [ -z "$git_sha" ]; then
          git_sha="${{ github.sha }}"
        fi

        echo "Creating multi-platform manifest for $image_tag..."
        docker buildx imagetools create \
          --tag "$registry:$image_tag" \
          "$registry:$image_tag-amd64" \
          "$registry:$image_tag-arm64"

        echo "Creating multi-platform manifest for Git SHA: $git_sha..."
        docker buildx imagetools create \
          --tag "$registry:$git_sha" \
          "$registry:$git_sha-amd64" \
          "$registry:$git_sha-arm64"

        echo "âœ… Multi-platform manifests created successfully"

    - name: Verify Manifests Contains Both Architectures
      shell: bash
      run: |
        registry="${{ steps.registry.outputs.url }}"
        image_tag="${{ inputs.image-tag }}"
        git_sha="${{ inputs.git-sha }}"

        if [ -z "$git_sha" ]; then
          git_sha="${{ github.sha }}"
        fi

        echo "ðŸ” Verifying image-tag manifest contains both architectures..."
        manifest_output=$(docker buildx imagetools inspect "$registry:$image_tag")

        if echo "$manifest_output" | grep -q "linux/amd64" && echo "$manifest_output" | grep -q "linux/arm64"; then
          echo "âœ… Image-tag manifest verified - contains both linux/amd64 and linux/arm64"
        else
          echo "âŒ Image-tag manifest verification failed - missing one or both architectures"
          echo "$manifest_output"
          exit 1
        fi

        echo "ðŸ” Verifying git-sha manifest contains both architectures..."
        manifest_output=$(docker buildx imagetools inspect "$registry:$git_sha")

        if echo "$manifest_output" | grep -q "linux/amd64" && echo "$manifest_output" | grep -q "linux/arm64"; then
          echo "âœ… Git-sha manifest verified - contains both linux/amd64 and linux/arm64"
        else
          echo "âŒ Git-sha manifest verification failed - missing one or both architectures"
          echo "$manifest_output"
          exit 1
        fi

        echo "ðŸ” Verifying both tags point to the same manifest..."
        image_tag_digest=$(docker buildx imagetools inspect "$registry:$image_tag" --raw | sha256sum | awk '{print $1}')
        git_sha_digest=$(docker buildx imagetools inspect "$registry:$git_sha" --raw | sha256sum | awk '{print $1}')

        if [ "$image_tag_digest" = "$git_sha_digest" ]; then
          echo "âœ… Both tags point to the same manifest digest"
        else
          echo "âš ï¸ Warning: Tags point to different manifests"
          echo "Image tag digest: $image_tag_digest"
          echo "Git SHA digest: $git_sha_digest"
          exit 1
        fi

        echo ""
        echo "Summary:"
        echo "   Tags: $image_tag, $git_sha"
        echo "   Architectures: linux/amd64, linux/arm64"
        echo "   Digest: sha256:$image_tag_digest"

        # Write GitHub Step Summary
        echo "## Multi-Architecture Manifest Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Registry** | \`$registry\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Image Tag** | \`$image_tag\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Git SHA** | \`$git_sha\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Architectures** | \`linux/amd64\`, \`linux/arm64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Manifest Digest** | \`sha256:$image_tag_digest\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Created Manifests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- \`$registry:$image_tag\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`$registry:$git_sha\`" >> $GITHUB_STEP_SUMMARY
