name: 'Create Multi-Architecture Manifest'
description: 'Creates and pushes multi-platform Docker manifests for amd64 and arm64 to Harbor'
inputs:
  image-tag:
    description: 'Image tag to create manifest for'
    required: true
  service-name:
    description: 'Name of sevice for location retrieve images in container repo'
    required: true
  business-unit:
    description: 'business-unit of app for Harbor'
    required: true
  git-sha:
    description: 'Git SHA to create manifest for (defaults to github.sha)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Validate registry inputs
      shell: bash
      run: |
        if [ -z "${{ inputs.service-name }}" ]; then
          echo "âŒ [multi-arch-manifest] Service name not provided. Cannot build manifest without service name."
          echo "ðŸ”Ž Solution: Add 'service-name' field to the 'multi-arch-manifest' action."
          exit 1
        fi
        if [ -z "${{ inputs.business-unit }}" ]; then
          echo "âŒ [multi-arch-manifest] business-unit not provided. Cannot pull from Harbor without business-unit."
          echo "ðŸ”Ž Solution: Add 'business-unit' field to the 'multi-arch-manifest' action."
          exit 1
        fi

    - name: Set active registry
      id: registry
      shell: bash
      run: |
          echo "harbor_url=harbor.bisnow.cloud/${{ inputs.business-unit }}/${{ inputs.service-name }}" >> $GITHUB_OUTPUT
          echo "ecr_url=560285300220.dkr.ecr.us-east-1.amazonaws.com/${{ inputs.service-name }}" >> $GITHUB_OUTPUT

    - name: Checkout Repository
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Verify Architecture Images Exist
      shell: bash
      run: |
        harbor_registry="${{ steps.registry.outputs.harbor_url }}"
        ecr_registry="${{ steps.registry.outputs.ecr_url }}"
        image_tag="${{ inputs.image-tag }}"
        git_sha="${{ inputs.git-sha }}"

        if [ -z "$git_sha" ]; then
          git_sha="${{ github.sha }}"
        fi

        echo "ðŸ” Verifying all architecture images are available..."
        max_attempts=30
        attempt=0
        sleep_time=5

        while [ $attempt -lt $max_attempts ]; do
          harbor_tag_amd64_exists=false
          harbor_tag_arm64_exists=false
          harbor_sha_amd64_exists=false
          harbor_sha_arm64_exists=false
          ecr_tag_amd64_exists=false
          ecr_tag_arm64_exists=false
          ecr_sha_amd64_exists=false
          ecr_sha_arm64_exists=false

          echo "Checking image-tag AMD64 image in harbor..."
          if docker buildx imagetools inspect "$harbor_registry:$image_tag-amd64" >/dev/null 2>&1; then
            echo "âœ… Found: $harbor_registry:$image_tag-amd64"
            harbor_tag_amd64_exists=true
          else
            echo "â³ Waiting for: $harbor_registry:$image_tag-amd64"
          fi

          echo "Checking image-tag AMD64 image in ecr..."
          if docker buildx imagetools inspect "$ecr_registry:$image_tag-amd64" >/dev/null 2>&1; then
            echo "âœ… Found: $ecr_registry:$image_tag-amd64"
            harbor_tag_amd64_exists=true
          else
            echo "â³ Waiting for: $ecr_registry:$image_tag-amd64"
          fi

          echo "Checking image-tag ARM64 image in harbor..."
          if docker buildx imagetools inspect "$harbor_registry:$image_tag-arm64" >/dev/null 2>&1; then
            echo "âœ… Found: $harbor_registry:$image_tag-arm64"
            ecr_tag_arm64_exists=true
          else
            echo "â³ Waiting for: $harbor_registry:$image_tag-arm64"
          fi

          echo "Checking image-tag ARM64 image in ecr..."
          if docker buildx imagetools inspect "$ecr_registry:$image_tag-arm64" >/dev/null 2>&1; then
            echo "âœ… Found: $ecr_registry:$image_tag-arm64"
            ecr_tag_arm64_exists=true
          else
            echo "â³ Waiting for: $ecr_registry:$image_tag-arm64"
          fi

          echo "Checking git-sha AMD64 image in harbor..."
          if docker buildx imagetools inspect "$registry:$git_sha-amd64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$git_sha-amd64"
            harbor_sha_amd64_exists=true
          else
            echo "â³ Waiting for: $registry:$git_sha-amd64"
          fi
          
          echo "Checking git-sha AMD64 image in ecr..."
          if docker buildx imagetools inspect "$registry:$git_sha-amd64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$git_sha-amd64"
            ecr_sha_amd64_exists=true
          else
            echo "â³ Waiting for: $registry:$git_sha-amd64"
          fi

          echo "Checking git-sha ARM64 image in harbor..."
          if docker buildx imagetools inspect "$registry:$git_sha-arm64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$git_sha-arm64"
            harbor_sha_arm64_exists=true
          else
            echo "â³ Waiting for: $registry:$git_sha-arm64"
          fi

          echo "Checking git-sha ARM64 image in ecr..."
          if docker buildx imagetools inspect "$registry:$git_sha-arm64" >/dev/null 2>&1; then
            echo "âœ… Found: $registry:$git_sha-arm64"
            ecr_sha_arm64_exists=true
          else
            echo "â³ Waiting for: $registry:$git_sha-arm64"
          fi

          if [ "$harbor_tag_amd64_exists" = true ] && [ "$harbor_tag_arm64_exists" = true ] && [ "$harbor_sha_amd64_exists" = true ] && [ "$harbor_sha_arm64_exists" = true ] && [ "$ecr_tag_amd64_exists" = true ] && [ "$ecr_tag_arm64_exists" = true ] && [ "$ecr_sha_amd64_exists" = true ] && [ "$ecr_sha_arm64_exists" = true ]; then
            echo "âœ… All architecture images are available!"
            exit 0
          fi

          attempt=$((attempt + 1))
          if [ $attempt -lt $max_attempts ]; then
            echo "â³ Attempt $attempt/$max_attempts - waiting ${sleep_time}s before retry..."
            sleep $sleep_time
          fi
        done

        echo "âŒ Timeout waiting for architecture images to be available"
        echo "Harbor Image-tag AMD64 available: $harbor_tag_amd64_exists"
        echo "Harbor Image-tag ARM64 available: $harbor_tag_arm64_exists"
        echo "Harbor Git-SHA AMD64 available: $harbor_sha_amd64_exists"
        echo "Harbor Git-SHA ARM64 available: $harbor_sha_arm64_exists"
        echo "ECR Image-tag AMD64 available: $ecr_tag_amd64_exists"
        echo "ECR Image-tag ARM64 available: $ecr_tag_arm64_exists"
        echo "ECR Git-SHA AMD64 available: $ecr_sha_amd64_exists"
        echo "ECR Git-SHA ARM64 available: $ecr_sha_arm64_exists"
        exit 1

    - name: Create Multi-Platform Manifests
      shell: bash
      run: |
        registry="${{ steps.registry.outputs.url }}"
        image_tag="${{ inputs.image-tag }}"
        git_sha="${{ inputs.git-sha }}"

        if [ -z "$git_sha" ]; then
          git_sha="${{ github.sha }}"
        fi

        echo "Creating multi-platform manifest for $image_tag for Harbor..."
        docker buildx imagetools create \
          --tag "$harbor_registry:$image_tag" \
          "$harbor_registry:$image_tag-amd64" \
          "$harbor_registry:$image_tag-arm64"
          
        echo "Creating multi-platform manifest for $image_tag for ECR..."
        docker buildx imagetools create \
          --tag "$ecr_registry:$image_tag" \
          "$ecr_registry:$image_tag-amd64" \
          "$ecr_registry:$image_tag-arm64"

        echo "Creating multi-platform manifest for Git SHA for Harbor: $git_sha..."
        docker buildx imagetools create \
          --tag "$harbor_registry:$git_sha" \
          "$harbor_registry:$git_sha-amd64" \
          "$harbor_registry:$git_sha-arm64"

        echo "Creating multi-platform manifest for Git SHA for ECR: $git_sha..."
        docker buildx imagetools create \
          --tag "$ecr_registry:$git_sha" \
          "$ecr_registry:$git_sha-amd64" \
          "$ecr_registry:$git_sha-arm64"

        echo "âœ… Multi-platform manifests created successfully"

    - name: Verify Manifests Contains Both Architectures
      shell: bash
      run: |
        harbor_registry="${{ steps.registry.outputs.harbor_url }}"
        ecr_registry="${{ steps.registry.outputs.ecr_url }}"
        image_tag="${{ inputs.image-tag }}"
        git_sha="${{ inputs.git-sha }}"

        if [ -z "$git_sha" ]; then
          git_sha="${{ github.sha }}"
        fi

        echo "ðŸ” Verifying image-tag manifest contains both architectures..."
        harbor_manifest_output=$(docker buildx imagetools inspect "$harbor_registry:$image_tag")
        ecr_manifest_output=$(docker buildx imagetools inspect "$ecr_registry:$image_tag")

        if echo "$harbor_manifest_output" | grep -q "linux/amd64" && echo "$harbor_manifest_output" | grep -q "linux/arm64"; then
          echo "âœ… Harbor Image-tag manifest verified - contains both linux/amd64 and linux/arm64"
        else
          echo "âŒ Harbor Image-tag manifest verification failed - missing one or both architectures"
          echo "$harbor_manifest_output"
          exit 1
        fi

        if echo "$ecr_manifest_output" | grep -q "linux/amd64" && echo "$ecr_manifest_output" | grep -q "linux/arm64"; then
          echo "âœ… ECR Image-tag manifest verified - contains both linux/amd64 and linux/arm64"
        else
          echo "âŒ ECR Image-tag manifest verification failed - missing one or both architectures"
          echo "$ecr_manifest_output"
          exit 1
        fi

        echo "ðŸ” Verifying git-sha manifest contains both architectures..."
        harbor_manifest_output=$(docker buildx imagetools inspect "$harbor_registry:$git_sha")
        ecr_manifest_output=$(docker buildx imagetools inspect "$ecr_registry:$git_sha")

        if echo "$harbor_manifest_output" | grep -q "linux/amd64" && echo "$harbor_manifest_output" | grep -q "linux/arm64"; then
          echo "âœ… Harbor Git-sha manifest verified - contains both linux/amd64 and linux/arm64"
        else
          echo "âŒ Harbor Git-sha manifest verification failed - missing one or both architectures"
          echo "$harbor_manifest_output"
          exit 1
        fi

        if echo "$ecr_manifest_output" | grep -q "linux/amd64" && echo "$ecr_manifest_output" | grep -q "linux/arm64"; then
          echo "âœ… ECR Git-sha manifest verified - contains both linux/amd64 and linux/arm64"
        else
          echo "âŒ ECR Git-sha manifest verification failed - missing one or both architectures"
          echo "$harbor_manifest_output"
          exit 1
        fi

        echo "ðŸ” Verifying both tags point to the same manifest..."
        harbor_image_tag_digest=$(docker buildx imagetools inspect "$harbor_registry:$image_tag" --raw | sha256sum | awk '{print $1}')
        harbor_git_sha_digest=$(docker buildx imagetools inspect "$harbor_registry:$git_sha" --raw | sha256sum | awk '{print $1}')
        ecr_image_tag_digest=$(docker buildx imagetools inspect "$ecr_registry:$image_tag" --raw | sha256sum | awk '{print $1}')
        ecr_git_sha_digest=$(docker buildx imagetools inspect "$ecr_registry:$git_sha" --raw | sha256sum | awk '{print $1}')

        if [ "$harbor_image_tag_digest" = "$harbor_git_sha_digest" ]; then
          echo "âœ… Both Harbor tags point to the same manifest digest"
        else
          echo "âš ï¸ Warning: Harbor Tags point to different manifests"
          echo "Image tag digest: $harbor_image_tag_digest"
          echo "Git SHA digest: $harbor_git_sha_digest"
          exit 1
        fi

        if [ "$ecr_image_tag_digest" = "$ecr_git_sha_digest" ]; then
          echo "âœ… Both ECR tags point to the same manifest digest"
        else
          echo "âš ï¸ Warning: ECR Tags point to different manifests"
          echo "Image tag digest: $ecr_image_tag_digest"
          echo "Git SHA digest: $ecr_git_sha_digest"
          exit 1
        fi

        echo ""
        echo "Summary:"
        echo "   Tags: $image_tag, $git_sha"
        echo "   Architectures: linux/amd64, linux/arm64"
        echo "   Harbor Digest: sha256:$harbor_image_tag_digest"
        echo "   ECR Digest: sha256:$ecr_image_tag_digest"

        # Write GitHub Step Summary
        echo "## Multi-Architecture Manifest Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Harbor Registry** | \`$harbor_registry\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **ECR Registry** | \`$ecr_registry\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Image Tag** | \`$image_tag\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Git SHA** | \`$git_sha\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Architectures** | \`linux/amd64\`, \`linux/arm64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Harbor Manifest Digest** | \`sha256:$harbor_image_tag_digest\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **ECR Manifest Digest** | \`sha256:$ecr_image_tag_digest\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Created Manifests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- \`$harbor_registry:$image_tag\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`$harbor_registry:$git_sha\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`$ecr_registry:$image_tag\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`$ecr_registry:$git_sha\`" >> $GITHUB_STEP_SUMMARY
